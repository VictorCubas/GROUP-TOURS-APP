# Documentaci√≥n de Endpoints de Pagos y Se√±a

## üìã Tabla de Contenidos
1. [Nuevo Endpoint: Registrar Se√±a](#registrar-se√±a)
2. [Nuevo Endpoint: Registrar Pago](#registrar-pago)
3. [Pasajeros Pendientes](#pasajeros-pendientes)
4. [Endpoint Existente: Comprobantes](#comprobantes)
5. [Comparaci√≥n de Endpoints](#comparaci√≥n)
6. [Ejemplos de Uso](#ejemplos)

---

## üÜï Registrar Se√±a

### `POST /api/reservas/{id}/registrar-senia/`

Registra el pago de se√±a inicial para una reserva. Crea autom√°ticamente un ComprobantePago de tipo 'sena'.

#### Request Body:
```json
{
  "metodo_pago": "transferencia",     // REQUERIDO: efectivo, transferencia, tarjeta_debito, tarjeta_credito, cheque, qr, otro
  "referencia": "TRF-20251026-001",   // OPCIONAL: N√∫mero de referencia del banco/comprobante
  "observaciones": "Se√±a inicial",    // OPCIONAL: Notas adicionales
  "empleado": 1,                      // OPCIONAL: ID del empleado que registra (usa el primero si no se especifica)
  "distribuciones": [
    {
      "pasajero": 1,                  // ID del pasajero ya cargado (n√∫mero)
      "monto": 210.00
    },
    {
      "pasajero": "pendiente_1",      // ‚≠ê Especial: pasajero a√∫n no cargado (string)
      "monto": 210.00
    },
    {
      "pasajero": "pendiente_2",      // ‚≠ê Otro pasajero pendiente
      "monto": 210.00
    }
  ]
}
```

#### Respuesta Exitosa (201 Created):
```json
{
  "message": "Se√±a registrada exitosamente",
  "comprobante": {
    "id": 15,
    "numero_comprobante": "CPG-2025-0015",
    "reserva": 1,
    "reserva_codigo": "RSV-2025-0001",
    "fecha_pago": "2025-10-26T10:30:00Z",
    "tipo": "sena",
    "tipo_display": "Se√±a",
    "monto": "420.00",
    "metodo_pago": "transferencia",
    "metodo_pago_display": "Transferencia Bancaria",
    "referencia": "TRF-20251026-001",
    "observaciones": "Se√±a inicial",
    "empleado": 1,
    "empleado_nombre": "Juan",
    "empleado_apellido": "P√©rez",
    "pdf_generado": null,
    "activo": true,
    "distribuciones": [
      {
        "id": 25,
        "pasajero": 1,
        "pasajero_nombre": "Mar√≠a",
        "pasajero_apellido": "Gonz√°lez",
        "pasajero_documento": "12345678",
        "monto": "210.00",
        "observaciones": null,
        "fecha_creacion": "2025-10-26T10:30:00Z"
      },
      {
        "id": 26,
        "pasajero": 2,
        "pasajero_nombre": "Carlos",
        "pasajero_apellido": "L√≥pez",
        "pasajero_documento": "87654321",
        "monto": "210.00",
        "observaciones": null,
        "fecha_creacion": "2025-10-26T10:30:00Z"
      }
    ],
    "fecha_creacion": "2025-10-26T10:30:00Z",
    "fecha_modificacion": "2025-10-26T10:30:00Z"
  },
  "reserva": {
    "id": 1,
    "codigo": "RSV-2025-0001",
    "estado": "confirmada",              // ‚úÖ Estado actualizado autom√°ticamente
    "monto_pagado": 420.00,
    "saldo_pendiente": 6652.00,
    "puede_confirmarse": true
  }
}
```

#### Errores Posibles:
```json
// 400 Bad Request - Falta metodo_pago
{
  "error": "El campo metodo_pago es requerido"
}

// 400 Bad Request - Faltan distribuciones
{
  "error": "Debe especificar las distribuciones de pago para cada pasajero"
}

// 400 Bad Request - Pasajero no pertenece a la reserva
{
  "error": "El pasajero con ID 5 no pertenece a esta reserva"
}

// 400 Bad Request - Monto inv√°lido
{
  "error": "Monto inv√°lido: abc"
}

// 400 Bad Request - Reserva sin pasajeros
{
  "error": "La reserva no tiene pasajeros registrados"
}
```

#### Notas Importantes:
- ‚ö†Ô∏è **La distribuci√≥n NO es validada contra la se√±a m√≠nima**. Un pasajero puede recibir menos de su se√±a requerida.
- ‚úÖ Si alg√∫n pasajero no tiene su se√±a completa, la reserva **NO pasar√° a estado "confirmada"**.
- ‚úÖ El estado se actualiza autom√°ticamente seg√∫n la l√≥gica de `Reserva.puede_confirmarse()`.
- üí° El monto total se calcula autom√°ticamente sumando las distribuciones.

---

## üÜï Registrar Pago

### `POST /api/reservas/{id}/registrar-pago/`

Registra un pago parcial o completo posterior a la se√±a. Crea un ComprobantePago con el tipo especificado.

#### Request Body:
```json
{
  "tipo": "pago_parcial",              // REQUERIDO: "pago_parcial" o "pago_total"
  "metodo_pago": "efectivo",           // REQUERIDO
  "referencia": "REC-001",             // OPCIONAL
  "observaciones": "Segundo pago",     // OPCIONAL
  "empleado": 1,                       // OPCIONAL
  "distribuciones": [                  // REQUERIDO
    {
      "pasajero": 1,
      "monto": 1000.00
    },
    {
      "pasajero": 2,
      "monto": 1500.00
    }
  ]
}
```

#### Respuesta Exitosa (201 Created):
```json
{
  "message": "Pago registrado exitosamente",
  "comprobante": {
    "id": 16,
    "numero_comprobante": "CPG-2025-0016",
    "tipo": "pago_parcial",
    "monto": "2500.00",
    // ... similar a registrar-senia
  },
  "reserva": {
    "id": 1,
    "codigo": "RSV-2025-0001",
    "estado": "finalizada",              // ‚úÖ Puede cambiar a "finalizada" si pago completo
    "monto_pagado": 2920.00,
    "saldo_pendiente": 4152.00,
    "esta_totalmente_pagada": false
  }
}
```

#### Errores Posibles:
```json
// 400 Bad Request - Tipo inv√°lido
{
  "error": "El tipo debe ser \"pago_parcial\" o \"pago_total\""
}

// 400 Bad Request - Falta campo tipo
{
  "error": "El campo tipo es requerido (pago_parcial o pago_total)"
}

// ... Resto de errores similares a registrar-senia
```

---

## üë§ Pasajeros Pendientes

### ¬øQu√© es un pasajero "pendiente"?

Cuando creas una reserva, no siempre tienes todos los datos de los pasajeros inmediatamente. El sistema permite usar `{"pasajero": "pendiente", "monto": 210.00}` para asignar pagos a pasajeros que a√∫n no han sido cargados.

### C√≥mo funciona:

1. **Se crean autom√°ticamente** pasajeros especiales con documento `'PENDIENTE'`, `'PENDIENTE_1'`, `'PENDIENTE_2'`, etc.
2. **Son √∫nicos por reserva** - si ya existe, se reutiliza
3. **Los pagos se asignan** a estos pasajeros temporales
4. **M√°s adelante** se puede reasignar el pago cuando se carguen los pasajeros reales

### Formatos soportados:

**IMPORTANTE**: Los pasajeros pendientes usan los datos de contacto del **TITULAR** (email, tel√©fono) para que las comunicaciones lleguen correctamente.

| Valor en API | Documento | Nombre | Email | Tel√©fono |
|--------------|-----------|--------|-------|----------|
| `"pendiente"` | `{doc_titular}_PEND` | `Por Asignar` | Email del titular | Tel. del titular |
| `"pendiente_1"` | `{doc_titular}_PEND_1` | `Por Asignar 1` | Email del titular | Tel. del titular |
| `"pendiente_2"` | `{doc_titular}_PEND_2` | `Por Asignar 2` | Email del titular | Tel. del titular |
| `"pendiente_3"` | `{doc_titular}_PEND_3` | `Por Asignar 3` | Email del titular | Tel. del titular |

**Ejemplo**: Si titular tiene documento `"12345678"`:
- Pendiente 1 ‚Üí Documento: `"12345678_PEND_1"`
- Pendiente 2 ‚Üí Documento: `"12345678_PEND_2"`

### Informaci√≥n del pasajero pendiente (ejemplo):

**Titular de la reserva:**
```json
{
  "id": 5,
  "nombre": "Juan",
  "apellido": "P√©rez",
  "documento": "12345678",
  "email": "juan@example.com",
  "telefono": "+595981123456"
}
```

**Pasajero pendiente creado:**
```json
{
  "id": 123,  // ID autogenerado
  "persona": {
    "id": 50,
    "nombre": "Por Asignar 1",                  // ‚úÖ Gen√©rico (claro que falta cargar)
    "apellido": "",
    "documento": "12345678_PEND_1",             // ‚úÖ Basado en titular (√∫nico)
    "email": "juan@example.com",                // ‚úÖ Del titular (comunicaciones)
    "telefono": "+595981123456"                 // ‚úÖ Del titular (comunicaciones)
  },
  "es_titular": false,
  "precio_asignado": 5000.00,  // Toma precio_unitario de la reserva
  "monto_pagado": 210.00,      // Suma de pagos asignados a este pasajero
  "se√±a_requerida": 210.00,
  "tiene_sena_pagada": true
}
```

**Ventajas:**
- ‚úÖ Nombre claro: "Por Asignar 1" indica que falta cargar datos
- ‚úÖ Emails/SMS llegan al titular (email y tel√©fono reales)
- ‚úÖ Documento √∫nico: No hay conflictos con m√∫ltiples pendientes
- ‚úÖ Trazabilidad: Se puede identificar a qu√© reserva/titular pertenece

### Casos de uso:

#### **Caso 1: Titular NO viaja, 2 pasajeros sin cargar**
```json
// 1. Crear reserva
POST /api/reservas/
{
  "titular_id": 1,
  "cantidad_pasajeros": 2,
  "titular_como_pasajero": false,  // Titular NO viaja
  // ...
}

// 2. Pagar se√±a sin pasajeros cargados
POST /api/reservas/1/registrar-senia/
{
  "metodo_pago": "transferencia",
  "distribuciones": [
    {"pasajero": "pendiente_1", "monto": 210.00},  // ‚≠ê Pasajero pendiente 1
    {"pasajero": "pendiente_2", "monto": 210.00}   // ‚≠ê Pasajero pendiente 2
  ]
}
// ‚úÖ RESULTADO: Se crean 2 pasajeros pendientes diferentes:
//    - Documento: "PENDIENTE_1", Nombre: "Por Asignar 1"
//    - Documento: "PENDIENTE_2", Nombre: "Por Asignar 2"
```

#### **Caso 2: Titular viaja + 1 acompa√±ante sin cargar**
```json
// 1. Crear reserva (titular se agrega autom√°ticamente como pasajero)
POST /api/reservas/
{
  "titular_id": 1,
  "cantidad_pasajeros": 2,
  "titular_como_pasajero": true,  // Titular S√ç viaja (default)
  // ...
}
// Se crea autom√°ticamente: Pasajero 1 (titular)

// 2. Pagar se√±a
POST /api/reservas/1/registrar-senia/
{
  "metodo_pago": "transferencia",
  "distribuciones": [
    {"pasajero": 1, "monto": 210.00},             // Titular (ya existe)
    {"pasajero": "pendiente_1", "monto": 210.00}  // Acompa√±ante por cargar
  ]
}
```

#### **Caso 3: Titular NO viaja, 3 pasajeros sin cargar**
```json
POST /api/reservas/1/registrar-senia/
{
  "metodo_pago": "efectivo",
  "distribuciones": [
    {"pasajero": "pendiente_1", "monto": 210.00},
    {"pasajero": "pendiente_2", "monto": 210.00},
    {"pasajero": "pendiente_3", "monto": 210.00}
  ]
}
// ‚úÖ RESULTADO: Se crean 3 pasajeros pendientes diferentes
```

#### **Caso 4: Pago total sin distribuir (un solo pendiente)**
```json
POST /api/reservas/1/registrar-senia/
{
  "metodo_pago": "transferencia",
  "distribuciones": [
    {"pasajero": "pendiente", "monto": 420.00}  // Sin sufijo, usa "PENDIENTE"
  ]
}
// ‚ö†Ô∏è NOTA: Crea UN solo pasajero "PENDIENTE" que recibe $420
```

### ‚ö†Ô∏è Importante:

- **Pasajeros pendientes numerados**: Usa `"pendiente_1"`, `"pendiente_2"`, etc. para crear m√∫ltiples pasajeros distintos
- **Sin n√∫mero = un solo pendiente**: `"pendiente"` sin sufijo crea/usa un √∫nico pasajero con documento `"PENDIENTE"`
- **Cada uno es independiente**: Cada `"pendiente_X"` tiene su propio `monto_pagado`, `se√±a_requerida`, etc.
- **No afecta la confirmaci√≥n**: La reserva puede confirmarse si `monto_pagado >= se√±a_total` (validaci√≥n a nivel reserva cuando `datos_completos = false`)
- **Reasignaci√≥n futura**: Cuando cargues los pasajeros reales, puedes crear un endpoint para reasignar pagos

---

## üì¶ Comprobantes (Endpoint Existente)

### `POST /api/comprobantes/`

Endpoint gen√©rico para crear comprobantes. M√°s flexible pero requiere m√°s campos.

#### Request Body:
```json
{
  "reserva": 1,                        // REQUERIDO
  "tipo": "sena",                      // REQUERIDO: sena, pago_parcial, pago_total, devolucion
  "monto": 420.00,                     // REQUERIDO
  "metodo_pago": "transferencia",      // REQUERIDO
  "referencia": "TRF-001",             // OPCIONAL
  "observaciones": "",                 // OPCIONAL
  "empleado": 1,                       // REQUERIDO
  "distribuciones": [                  // REQUERIDO
    {"pasajero": 1, "monto": 210.00},
    {"pasajero": 2, "monto": 210.00}
  ]
}
```

#### Respuesta Exitosa:
```json
{
  "id": 15,
  "numero_comprobante": "CPG-2025-0015",
  "tipo": "sena",
  "monto": "420.00",
  // ... resto de campos del comprobante
}
```

---

## üîç Comparaci√≥n de Endpoints

| Caracter√≠stica | `/api/comprobantes/` | `/api/reservas/{id}/registrar-senia/` | `/api/reservas/{id}/registrar-pago/` |
|----------------|---------------------|---------------------------------------|--------------------------------------|
| **Uso principal** | Gesti√≥n administrativa | Registrar se√±a inicial | Pagos posteriores |
| **Campo `reserva`** | ‚úÖ Requerido | ‚ùå En la URL | ‚ùå En la URL |
| **Campo `tipo`** | ‚úÖ Requerido | ‚úÖ Autom√°tico (`sena`) | ‚úÖ Requerido |
| **Campo `monto`** | ‚úÖ Requerido | ‚úÖ Calculado autom√°tico | ‚úÖ Calculado autom√°tico |
| **Campo `empleado`** | ‚úÖ Requerido | ‚ö†Ô∏è Opcional (usa primero) | ‚ö†Ô∏è Opcional (usa primero) |
| **Validaci√≥n se√±a m√≠nima** | ‚ùå No | ‚ùå No | ‚ùå No |
| **Retorna estado reserva** | ‚ùå No | ‚úÖ S√≠ | ‚úÖ S√≠ |
| **Contexto espec√≠fico** | ‚ùå Gen√©rico | ‚úÖ Espec√≠fico para se√±a | ‚úÖ Espec√≠fico para pagos |

---

## üí° Ejemplos de Uso

### Caso 1: Registrar Se√±a Completa (todos pagan lo m√≠nimo)

```bash
POST /api/reservas/1/registrar-senia/
Content-Type: application/json

{
  "metodo_pago": "transferencia",
  "referencia": "TRF-001",
  "distribuciones": [
    {"pasajero": 1, "monto": 210.00},  // Se√±a m√≠nima
    {"pasajero": 2, "monto": 210.00}   // Se√±a m√≠nima
  ]
}
```
**Resultado**: Reserva pasa a estado `"confirmada"` ‚úÖ

---

### Caso 2: Registrar Se√±a Parcial (un pasajero paga menos)

```bash
POST /api/reservas/1/registrar-senia/
Content-Type: application/json

{
  "metodo_pago": "efectivo",
  "distribuciones": [
    {"pasajero": 1, "monto": 210.00},  // Se√±a completa
    {"pasajero": 2, "monto": 100.00}   // Menos que la se√±a ($210)
  ]
}
```
**Resultado**: Reserva se mantiene en `"pendiente"` ‚ö†Ô∏è (pasajero 2 no tiene se√±a completa)

---

### Caso 3: Titular paga toda la se√±a (sin distribuir)

```bash
POST /api/reservas/1/registrar-senia/
Content-Type: application/json

{
  "metodo_pago": "tarjeta_credito",
  "referencia": "AUTH-123456",
  "distribuciones": [
    {"pasajero": "pendiente", "monto": 420.00}  // Toda la se√±a sin asignar
  ]
}
```
**Resultado**: Reserva pasa a `"confirmada"` ‚úÖ (monto_pagado >= se√±a_total)

---

### Caso 4: Pago Parcial Posterior

```bash
POST /api/reservas/1/registrar-pago/
Content-Type: application/json

{
  "tipo": "pago_parcial",
  "metodo_pago": "transferencia",
  "referencia": "TRF-002",
  "distribuciones": [
    {"pasajero": 1, "monto": 1500.00},
    {"pasajero": 2, "monto": 1500.00}
  ]
}
```
**Resultado**: Si alcanza el total, pasa a `"finalizada"` ‚úÖ

---

### Caso 5: Pago Total

```bash
POST /api/reservas/1/registrar-pago/
Content-Type: application/json

{
  "tipo": "pago_total",
  "metodo_pago": "efectivo",
  "observaciones": "Pago completo del saldo restante",
  "distribuciones": [
    {"pasajero": 1, "monto": 2790.00},  // Saldo completo
    {"pasajero": 2, "monto": 2790.00}   // Saldo completo
  ]
}
```
**Resultado**: Reserva pasa a `"finalizada"` ‚úÖ

---

## üîÑ Flujo Completo de Pagos

```
1. Crear Reserva
   POST /api/reservas/
   Estado inicial: "pendiente"

2. Registrar Se√±a
   POST /api/reservas/1/registrar-senia/
   {
     "metodo_pago": "transferencia",
     "distribuciones": [
       {"pasajero": 1, "monto": 210.00},
       {"pasajero": 2, "monto": 210.00}
     ]
   }
   ‚úÖ Estado ‚Üí "confirmada"

3. Primer Pago Parcial
   POST /api/reservas/1/registrar-pago/
   {
     "tipo": "pago_parcial",
     "metodo_pago": "efectivo",
     "distribuciones": [
       {"pasajero": 1, "monto": 1500.00},
       {"pasajero": 2, "monto": 1500.00}
     ]
   }
   Estado: "confirmada" (a√∫n falta saldo)

4. Segundo Pago Parcial (saldo final)
   POST /api/reservas/1/registrar-pago/
   {
     "tipo": "pago_parcial",
     "metodo_pago": "transferencia",
     "distribuciones": [
       {"pasajero": 1, "monto": 1290.00},
       {"pasajero": 2, "monto": 1290.00}
     ]
   }
   ‚úÖ Estado ‚Üí "finalizada"
```

---

## üìä Estados de Reserva

| Estado | Descripci√≥n | Condici√≥n |
|--------|-------------|-----------|
| `pendiente` | Sin pago suficiente | `monto_pagado < se√±a_total` |
| `confirmada` | Se√±a pagada | Todos los pasajeros tienen `se√±a_requerida` pagada |
| `finalizada` | Pago completo | `monto_pagado >= costo_total_estimado` |
| `cancelada` | Cancelada | Manual |

---

## üéØ Recomendaciones

1. **Para frontend**: Usar `/api/reservas/{id}/registrar-senia/` y `/api/reservas/{id}/registrar-pago/`
   - M√°s simple
   - Retorna info completa de la reserva
   - Menos propenso a errores

2. **Para backoffice/admin**: Usar `/api/comprobantes/`
   - M√°s control
   - Permite casos especiales
   - Gesti√≥n administrativa

3. **Validar en frontend** antes de enviar:
   - Cada pasajero debe tener monto >= 0
   - La suma debe ser > 0
   - Verificar que todos los pasajeros est√©n incluidos

4. **Descargar PDF del comprobante**:
   ```bash
   GET /api/comprobantes/{comprobante_id}/descargar-pdf/
   ```

---

**Fecha**: 26 de Octubre, 2025
**Versi√≥n**: 1.0.0
**Autor**: Claude Code Assistant
